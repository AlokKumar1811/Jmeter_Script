name: JMeter Performance Tests (Multi-Stage)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # -------------------------------
  # Stage 1: Setup
  # -------------------------------
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download Apache JMeter
        run: |
          JMETER_VERSION=5.6.3
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz
          tar -xzf apache-jmeter-${JMETER_VERSION}.tgz
          mv apache-jmeter-${JMETER_VERSION} jmeter

      - name: Persist JMeter directory
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-bin
          path: jmeter

  # -------------------------------
  # Stage 2: Execute JMeter Test
  # -------------------------------
  test:
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore JMeter
        uses: actions/download-artifact@v4
        with:
          name: jmeter-bin
          path: jmeter

      - name: Make JMeter executable
        run: |
          chmod -R a+rx jmeter/bin

      - name: Run JMeter Test
        run: |
          mkdir -p results
          jmeter/bin/jmeter \
            -n \
            -t Test_File.jmx \
            -l results/results.jtl \
            -e \
            -o results/report

      - name: Persist Test Results
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results-full
          path: results

  # -------------------------------
  # Stage 3: Upload Artifacts
  # -------------------------------
  generate_results:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Download Results
        uses: actions/download-artifact@v4
        with:
          name: jmeter-results-full
          path: results

      - name: Upload JTL File
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results
          path: results/results.jtl

      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-html-report
          path: results/report

  # -------------------------------
  # Stage 4: Deploy to GitHub Pages
  # -------------------------------
  publish_HTML_results:
    runs-on: ubuntu-latest
    needs: generate_results

    steps:
      - name: Download HTML Report
        uses: actions/download-artifact@v4
        with:
          name: jmeter-html-report
          path: results/report

      - name: Deploy JMeter Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: results/report
          publish_branch: gh-pages
